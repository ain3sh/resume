## Context (current repo)
- Resume is rendered in React (`src/components/resume/*`) using `resumeData.ts` (`src/data/resumeData.ts`).
- PDFs are generated by cloning the DOM, rasterizing with `html2canvas`, then adding an off-screen ATS text layer + clickable link rectangles (`src/components/utils/customPDFGenerator.ts`). CI generates PDFs via Puppeteer against a Vercel deployment (`.github/workflows/update-pdfs.yml`, `.github/scripts/generate-pdfs.js`).

## Goals
1. Produce an ATS-friendly PDF with *real* text + real hyperlinks (no screenshot layer).
2. Reuse the same source-of-truth data (`src/data/resumeData.ts`) for both React preview and Typst PDF.
3. Make per-application customization fast/composable (profiles/overrides), without editing base data every time.
4. Keep existing React screenshot pipeline working during migration (optional fallback).

## Non-goals (for v1)
- Perfect 1:1 pixel match with the React/Tailwind render; we’ll target “visually equivalent” first and iterate.
- Building a full UI for editing profiles (CLI-first is fine).

---

## Proposed design (shared across options)
### A. New `typst/` layer (render-only)
Add a `typst/` directory containing a small “component library”:
- `typst/main.typ`: entrypoint; calls `resume(doc)` and selects theme/layout.
- `typst/theme.typ`: palette + text styles (light/dark to mirror `src/components/utils/themeStyles.tsx`).
- `typst/layout.typ`: page setup (paper, margins), two-column layout, spacing.
- `typst/sections/*.typ`: renderers mirroring React sections:
  - `header.typ` (name + contact line + links)
  - `projects.typ`, `skills.typ`, `publications.typ`, `education.typ`, `experience.typ`
- `typst/primitives.typ`: bullets, small caps/bold helpers, “section header with icon” helper.

Typst styling intent:
- Bullet markers: filled circle for level-0, hollow circle for nested (Typst `show list.item` pattern).
- Links: `#show link: set text(theme.link)` plus underline behavior.
- Icons: v1 uses Unicode symbols or small inline SVGs via `image("...")` (optional toggle); if too fiddly, we omit icons in v1 and re-add later.

### B. Generate a Typst-friendly data module from TS
Because Typst’s external-data APIs vary by version and the docs lookup didn’t give reliable signatures, we’ll avoid relying on `json.decode` and instead generate a `*.typ` module.

We add a Node script that:
1. Loads `src/data/resumeData.ts` by transpiling it with the `typescript` dependency (already in `package.json`) and evaluating it in a `vm` sandbox.
2. Optionally applies a “profile” transform (see below).
3. Writes `typst/generated/resume_data.typ` containing something like:
   - `#let resume = (personalInfo: (...), education: (...), ...)`
4. Typst templates import it: `#import "generated/resume_data.typ": resume`.

This keeps `resumeData.ts` as the source of truth, without adding `ts-node`/`esbuild` deps.

### C. CLI commands / outputs
- `node scripts/generate-typst-data.js --profile <name> --out typst/generated/resume_data.typ`
- `typst compile typst/main.typ pdfs/<profile>-resume.pdf` (plus theme flags)

We’ll add npm scripts later in implementation (e.g., `npm run typst:pdf -- --profile=...`).

---

## Per-application composability (“profiles”)
You’ll get a first-class mechanism for “passthrough” and fine-tuning.

### Profiles: what they are
A profile is a pure function `ResumeData -> ResumeData` (no side effects) that can:
- include/exclude entries (e.g., drop one project)
- reorder sections or items
- trim/rewrite bullets
- inject a role/company-specific summary line

### Primitives we’ll implement (TS side)
These operate on the existing schema without forcing you to rewrite the data model immediately:
- `pickByCompany(experience, ["Tilli Software", "JHU APL"])`
- `limitBullets(experience, {"Tilli Software": 3})`
- `rewrite(text, replacements)` (e.g., “ERP” -> “enterprise resource planning”)
- `preferKeywords(bullets, keywords)` (stable heuristic ordering; no LLM)
- `dropIf(predicate)` and `mapIf(predicate, mapper)` utilities.

Profiles live in e.g. `src/profiles/*.ts` and are importable by both:
- React app (for preview via `?profile=acme-swe`)
- Typst generator script (to produce matching PDFs)

---

## Option A (Minimal): TS profiles + generated Typst data
### What you get
- A working Typst resume that renders from `resumeData.ts`.
- Simple profile transforms keyed by existing fields (company/name), plus a handful of utilities.
- A reproducible CLI path to compile a true-text PDF.

### Acceptance criteria
- Generated PDF text is selectable/searchable.
- Links are real hyperlinks (mailto + https).
- Visual structure matches current React resume: centered header; two columns; same section ordering; bullet styling close.

---

## Option B (Smart): add stable IDs/tags + profile rule engine
Everything in Option A, plus:

### Data model enhancements (backwards compatible)
Extend `src/types/resume.ts` with optional fields:
- `id?: string` on `Experience`, `Project`, `Education`, and on each `achievement`.
- `tags?: string[]` on achievements.

Update `resumeData.ts` minimally by adding IDs (and tags where useful). React rendering stays unchanged.

### Rule engine primitives
Profiles can now target specific bullets deterministically:
- `includeIds(["exp:tilli", "exp:jhu-apl"])`
- `includeAchievementIds(["ach:tilli:agent-mvp"])`
- `tagBoost(["erp", "automation"])` / `tagFilter(["ml"])`

### Why it matters
- Per-application variants become “diffable” and fast: you toggle IDs/tags instead of editing prose.
- Enables future automation (e.g., generate a tailored PDF from a small config file).

---

## CI plan (later implementation)
Keep the current Puppeteer/Vercel workflow as-is.
Add an additional workflow/job (or extend existing one) that:
- installs Typst (pinned version)
- runs the generator + `typst compile`
- uploads generated PDFs as artifacts and/or commits to `pdfs/` if desired

(We’ll decide whether to commit typst PDFs into `pdfs/` or keep them as build artifacts; committing keeps parity with current approach.)

---

## Open questions (quick answers help)
1. Target paper size: `letter` or `a4`?
2. Do you want the Typst output to support the dark theme, or is ATS-first (light) the priority?
3. Do you want icons in v1, or should we drop them initially and re-add after layout matches?

If you pick an option, I’ll proceed to implement it end-to-end (generator script + typst templates + profile system), then add a fast local command to build a PDF.